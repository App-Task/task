<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Tasks</title>
  <style>
    body { font-family: sans-serif; background: #f8f8f8; padding: 20px; }
    h1 { color: #215432; text-align: center; }
    .controls { display: flex; gap: 10px; margin-bottom: 20px; }
    .input { padding: 8px; border-radius: 5px; border: 1px solid #ccc; width: 200px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; }
    th { background: #215432; color: white; text-align: left; }
  </style>
</head>
<body>

    <div style="margin-bottom: 20px;">
        <a href="/admin/index.html" style="background: #215432; color: white; padding: 10px 16px; border-radius: 6px; text-decoration: none; font-weight: bold;">‚Üê Back to Dashboard</a>
      </div>
      
  <h1>Tasks</h1>

  <div class="controls">
    <input type="text" class="input" id="search" placeholder="Search by title..." />
    <select class="input" id="statusFilter">
      <option value="">All Status</option>
      <option value="Pending">Pending</option>
      <option value="Started">Started</option>
      <option value="Completed">Completed</option>
      <option value="Cancelled">Cancelled</option>
    </select>
  </div>

  <table id="taskTable">
    <thead>
      <tr>
        <th>Title</th>
        <th>Description</th>
        <th>Location</th>
        <th>Client</th>
        <th>Tasker</th>
        <th>Status</th>
        <th>Created</th>
        <th>Cancelled/Completed</th>
        <th>Bids</th>
        <th>Accepted Bid</th>

      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let allTasks = [];
    let currentPage = 1;
    let totalTasks = 0;
  
    async function fetchTasks() {
      const res = await axios.get(`/api/admin/tasks?page=${currentPage}&limit=10`);
      allTasks = res.data.tasks;
      totalTasks = res.data.total;
  
      renderTasks(allTasks);
      renderPagination();
    }
  
    function renderTasks(data) {
      const tbody = document.querySelector("#taskTable tbody");
      tbody.innerHTML = "";
  
      data.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
  <td>${t.title}</td>
  <td>${t.description}</td>
  <td>${t.location}</td>
  <td>${t.clientName}</td>
  <td>${t.taskerName || "‚Äî"}</td>
  <td>${t.status}</td>
  <td>${new Date(t.createdAt).toLocaleString()}</td>
  <td>${
    t.completedAt
      ? new Date(t.completedAt).toLocaleString()
      : t.cancelledAt
      ? new Date(t.cancelledAt).toLocaleString()
      : "‚Äî"
  }</td>
  <td>
    ${t.bids.length > 0
      ? t.bids.map(b => `üí∞ ${b.price} ‚Äì ${b.tasker}`).join("<br>")
      : "‚Äî"}
  </td>
  <td>
    ${t.acceptedBid
      ? `‚úÖ ${t.acceptedBid.tasker}<br>üí∞ ${t.acceptedBid.price}<br>${t.acceptedBid.message}`
      : "‚Äî"}
  </td>
`;

        tbody.appendChild(tr);
      });
    }
  
    function renderPagination() {
      const totalPages = Math.ceil(totalTasks / 10);
      const controlsDiv = document.querySelector(".controls");
  
      // Remove old pagination
      const old = document.querySelector(".pagination-buttons");
      if (old) old.remove();
  
      // Create new pagination
      let html = '<div class="pagination-buttons">';
      for (let i = 1; i <= totalPages; i++) {
        html += `<button onclick="goToPage(${i})" style="margin-left: 6px;">${i}</button>`;
      }
      html += '</div>';
      controlsDiv.insertAdjacentHTML("beforeend", html);
    }
  
    function goToPage(page) {
      currentPage = page;
      fetchTasks();
    }
  
    // Filters
    document.getElementById("search").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allTasks.filter(t => t.title.toLowerCase().includes(term));
      renderTasks(filtered);
    });
  
    document.getElementById("statusFilter").addEventListener("change", (e) => {
      const value = e.target.value;
      const filtered = value ? allTasks.filter(t => t.status === value) : allTasks;
      renderTasks(filtered);
    });
  
    fetchTasks();
  </script>
  
</body>
</html>
